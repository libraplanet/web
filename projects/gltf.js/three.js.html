<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>three.js</title>
		<script src="three.js/three.min.js"></script> 
		<script src="three.js/GLTFLoader.js"></script> 
		<script src="three.js/OrbitControls.js"></script> 
		<script src="three.js/TrackballControls.js"></script> 
		<script src="three.js/stats.min.js"></script> 

		<script type="text/javascript">

			var Contexts = function() {
				var self = this;
				self.canvas = undefined;
				self.renderer = undefined;
				self.scene = undefined;
				self.stats = undefined;
			};
			var Gear = function() {
				var self = this;
				/**
				 * member properties.
				 */
				self.cnt = 0;
				self.camera = undefined;;
				self.directionalLight = undefined;;
				self.controls = undefined;;
				self.sceneMeshes = undefined;
				self.axesHelper = undefined;
				self.meshTextPlaneX = undefined;
				self.meshTextPlaneY = undefined;
				self.meshTextPlaneZ = undefined;

				/**
				 * Gear.init()
				 */
				self.init = function(contexts, width, height) {
					var scene = contexts.scene;
					var renderer = contexts.renderer;
					var camera, directionalLight;

					//camera
					(function() {
						camera = self.camera = new THREE.PerspectiveCamera(50, width / height, 1, 2000);
						camera.position.set(0, 1, 7);
					})();
					//control
					(function() {
						var controls = self.controls = new THREE.TrackballControls(camera, renderer.domElement);
						controls.staticMoving = true;
					})();
					//light
					(function() {
						(function() {
							var light = new THREE.AmbientLight(0xFFFFFF, 0.5);
							//light.castShadow = true;
							scene.add(light);
						})();
						(function() {
							var light = directionalLight = self.directionalLight = new THREE.DirectionalLight(0xFFFFFF, 0.75);
							light.position.set(-2, 2, 5);
							light.castShadow = true;
							light.shadow.mapSize.width = 512;
							light.shadow.mapSize.height = 512;
							light.shadow.camera.near = 1;
							light.shadow.camera.far = 2000;
							scene.add(light);
							scene.add(light.target);
						})();
					})();
					//mesh
					(function() {
						var loader = new THREE.GLTFLoader();
						var path = './three.js/Duck.gltf';
						//var path = './three.js/BoomBox.glb';
						//var path = './three.js/Buggy.glb';
						loader.load(path, function(data){
							var sceneMeshes = self.sceneMeshes = data.scenes;
							Array.prototype.forEach.call(sceneMeshes, function(mesh) {
								mesh.castShadow = true;
								mesh.receiveShadow = false;
								scene.add(mesh);
							});
						});
					})();
					//plane
					(function() {
						(function() {
							var geometry = new THREE.PlaneBufferGeometry(10, 5 + 1, 1);
							var material = new THREE.MeshLambertMaterial({color: 0xFFFFFF});
							var plane = new THREE.Mesh(geometry, material);
							plane.position.set(0, 2.5 - 0.5, -5);
							plane.castShadow = false;
							plane.receiveShadow = true;
							scene.add(plane);
						})();
						(function() {
							var geometry = new THREE.PlaneBufferGeometry(10, 10, 1);
							var material = new THREE.MeshLambertMaterial({color: 0xFFFFFF});
							var plane = new THREE.Mesh(geometry, material);
							var q = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(-1, 0, 0), Math.PI / 2);
							plane.position.set(0, -1, 0);
							plane.quaternion.copy(q);
							plane.castShadow = false;
							plane.receiveShadow = true;
							scene.add(plane);
						})();
					})();
					//AxesHelper
					(function() {
						var axesHelper = self.axesHelper = new THREE.AxesHelper(1);
						scene.add(axesHelper);

						axesHelper.position.set(0,0,0);
						axesHelper.rotation.set(0,0,0);
						axesHelper.position.set(-3, -1 , 0);
					})();
					//helper(directionalLight light)
					(function() {
						var helper = new THREE.DirectionalLightHelper(directionalLight, 5, 0x0000FF);
						scene.add(helper);
					})();
					//helper(directionalLight shadow)
					(function() {
						var helper = new THREE.CameraHelper(directionalLight.shadow.camera);
						scene.add(helper);
					})();

					//grid
					(function() {
						const grid = new THREE.GridHelper(10, 10);
						scene.add(grid);
					})();
				};

				/**
				 * Gear.update
				 */
				self.update = function(contexts) {
					(function() {
						var camera = self.camera;
						var light = self.directionalLight;
						var target = light.target;
						var pos = self.camera.position;
						light.position.copy(pos);
					})();
				};

				/**
				 * Gear.render
				 */
				self.render = function(contexts) {
					var renderer = contexts.renderer;
					var scene = contexts.scene;
					var camera = self.camera;
					renderer.render(scene, camera);
				};
			};

			window.onload = function() {
				var contexts = new Contexts();
				var gear = new Gear();

				(function() {
					var width  = window.innerWidth;
					var height = window.innerHeight;
					var canvas = contexts.canvas = document.querySelectorAll("#canvas")[0];
					var renderer = contexts.renderer = new THREE.WebGLRenderer({
						canvas: canvas,
						antialias: true
					});
					var scene  = contexts.scene = new THREE.Scene();
					var stats = contexts.stats = new Stats();

					renderer.setSize(width, height);
					renderer.setClearColor(0xF0F0F0, 1.0);
					renderer.shadowMap.enabled = true;

					gear.init(contexts, width, height);

					document.body.appendChild( stats.dom );

				})();

				// event handler
				(function() {
					// general
					(function() {
						window.addEventListener('resize', function(e) {
							var renderer = contexts.renderer;
							var scene = contexts.scene;
							var camera = gear.camera;
							var controls = gear.controls;
							var width  = window.innerWidth;
							var height = window.innerHeight;
							camera.aspect = width / height;
							camera.updateProjectionMatrix();
							renderer.setSize(width, height);
							controls.handleResize();
							renderer.render(scene, camera);

							console.log('resize(' + width + ', ' + height + ')')
						}, false);
					})();
					// canvas
					(function() {
						var canvas = contexts.canvas;
						canvas.addEventListener(null, function(e) {
						}, false);
						canvas.addEventListener('webglcontextlost', function(e) {
						}, false);
						canvas.addEventListener('webglcontextrestored', function(e) {
						}, false);
					})();
					// control
					(function() {
					})();
				})();

				//render
				(function() {
					var animate = function() {
						requestAnimationFrame(animate);

						gear.controls.update();
						gear.update(contexts);
						gear.render(contexts);
						contexts.stats.update();
					};
					animate();
					//setInterval(tick, 1000/20);
				})();
			};

		</script> 
		<style type="text/css">
		<!--
			body {
				overscroll-behavior-y: none;
			}
			html, body {
				overflow: hidden;
				width   : 100%;
				height  : 100%;
				margin  : 0;
				padding : 0;
			}
			canvas#canvas {
				width:100%;
				height:100%;
			};
		-->
		</style> 
	</head>
	<body>
		<canvas id="canvas"></canvas>
	</body>
</html>
